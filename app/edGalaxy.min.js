"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();angular.module("edGalaxyMap",["ui.bootstrap","ui.gravatar","ngRoute","ngCookies"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]).factory("authInterceptor",["$rootScope","$q","$cookieStore","$location",function(a,b,c,d){return{request:function(a){return a.headers=a.headers||{},c.get("token")&&(a.headers.Authorization="Bearer "+c.get("token")),a},responseError:function(a){return 401===a.status?(d.path("/login"),c.remove("token"),b.reject(a)):b.reject(a)}}}]),angular.module("edGalaxyMap").factory("listingsFactory",["$http",function(a){var b=function(){function b(){_classCallCheck(this,b)}return _createClass(b,[{key:"find",value:function(){return a.get("/api/listings").then(function(a){return a.data})}},{key:"findListingsByStationId",value:function(b){return a.get("/api/listings/station/"+b).then(function(a){return a.data})}}]),b}();return new b}]),angular.module("edGalaxyMap").factory("stationsFactory",["$http",function(a){var b=function(){function b(){_classCallCheck(this,b)}return _createClass(b,[{key:"find",value:function(){return a.get("/api/stations").then(function(a){return a.data})}},{key:"findStationsBySystemId",value:function(b){return a.get("/api/stations/"+b).then(function(a){return a.data})}}]),b}();return new b}]),angular.module("edGalaxyMap").factory("systemsFactory",["$http",function(a){var b=function(){function b(){_classCallCheck(this,b)}return _createClass(b,[{key:"find",value:function(){return a.get("/models/systems.json").then(function(a){return a.data})}}]),b}();return new b}]),angular.module("edGalaxyMap").factory("userFactory",["$http","$q","$cookieStore",function(a,b,c){var d=function(){function d(){_classCallCheck(this,d)}return _createClass(d,[{key:"login",value:function(d,e){var f=e||angular.noop,g=b.defer();return a.post("/auth/local",{email:d.email,password:d.password}).success(function(a){return c.put("token",a.token),c.put("user",a.user),g.resolve(a),f()}).error(function(a){return this.logout(),g.reject(a),f(a)}.bind(this)),g.promise}},{key:"register",value:function(d,e){var f=e||angular.noop,g=b.defer();return a.post("/api/user",{name:d.name,email:d.email,password:d.password}).success(function(a){return c.put("token",a.token),c.put("user",a.user),g.resolve(a),f()}).error(function(a){return this.logout(),g.reject(a),f(a)}.bind(this)),g.promise}},{key:"logout",value:function(){c.remove("token"),c.remove("user")}}]),d}();return new d}]),angular.module("edGalaxyMap").service("listingsService",["$q","listingsFactory",function(a,b){var c=function(){function c(){_classCallCheck(this,c),this.listings=[],this.loading=!1}return _createClass(c,[{key:"findListingsByStationId",value:function(c){return new a(function(a,d){this.loading=!0,this.listings.length=0,b.findListingsByStationId(c).then(function(a){this.listings=a,this.loading=!1,this.errors=!1}.bind(this)).then(a)["catch"](function(a){return this.loading=!1,this.errors=!0,d(a)}.bind(this))}.bind(this))}}]),c}();return new c}]),angular.module("edGalaxyMap").service("stationsService",["$q","stationsFactory",function(a,b){var c=function(){function c(){_classCallCheck(this,c),this.stations=[],this.selectedStation,this.loading=!1}return _createClass(c,[{key:"findStationsBySystemId",value:function(c){return new a(function(a,d){this.loading=!0,this.stations.length=0,b.findStationsBySystemId(c).then(function(a){this.stations=a,this.selectedStation=a[0],this.loading=!1,this.errors=!1}.bind(this)).then(a)["catch"](function(a){return this.loading=!1,this.errors=!0,d(a)}.bind(this))}.bind(this))}},{key:"findAllStations",value:function(){return new a(function(a,c){this.loading=!0,b.find().then(function(a){this.stations=a,this.selectedStation=a[0],this.loading=!1,this.errors=!1}.bind(this)).then(a)["catch"](function(a){return this.loading=!1,this.errors=!0,c(a)}.bind(this))}.bind(this))}}]),c}();return new c}]),angular.module("edGalaxyMap").service("systemsService",["$q","systemsFactory",function(a,b){var c=function(){function c(){_classCallCheck(this,c),this.systems=[],this.selectedSystem}return _createClass(c,[{key:"init",value:function(){return new a(function(a,c){this.loading=!0,b.find().then(function(a){this.systems=a,this.selectedSystem=a[0],this.loading=!1,this.errors=!1}.bind(this)).then(a)["catch"](function(a){return this.loading=!1,this.errors=!0,c(a)}.bind(this))}.bind(this))}},{key:"setSelectedSystem",value:function(a){this.selectedSystem=a}}]),c}();return new c}]),angular.module("edGalaxyMap").service("userService",["$q","userFactory","$cookieStore",function(a,b,c){var d=function(){function d(){_classCallCheck(this,d),this.isLoggedIn=!1}return _createClass(d,[{key:"init",value:function(){c.get("user")?(this.user=c.get("user"),this.isLoggedIn=!0):(this.user={},this.isLoggedIn=!1)}},{key:"login",value:function(c){return new a(function(a,d){this.loading=!0,b.login(c).then(function(a,b){this.user=a,this.isLoggedIn=!0,this.loading=!1,this.errors=!1}.bind(this)).then(a)["catch"](function(a){return this.user={},this.isLoggedIn=!1,this.loading=!1,this.errors=!0,d(a)}.bind(this))}.bind(this))}},{key:"register",value:function(c){return new a(function(a,d){this.loading=!0,b.register(c).then(function(a,b){this.user=a,this.isLoggedIn=!0,this.loading=!1,this.errors=!1}.bind(this)).then(a)["catch"](function(a){return this.user={},this.isLoggedIn=!1,this.loading=!1,this.errors=!0,d(a)}.bind(this))}.bind(this))}},{key:"logout",value:function(){this.user={},this.isLoggedIn=!1,b.logout()}}]),d}();return new d}]),angular.module("edGalaxyMap").controller("MainCtrl",["$scope","userService",function(a,b){b.init()}]),angular.module("edGalaxyMap").directive("edSystemMap",["$q","systemsService","$rootScope","stationsService",function(a,b,c,d){return{restrict:"E",link:function(e,f,g){function h(){q(!1);var a=THREE.ImageUtils.loadTexture("models/system_color_palette.png");a.minFilter=THREE.NearestFilter;var c=THREE.ImageUtils.loadTexture("models/circle.png");c.minFilter=THREE.LinearFilter,F={activeColoring:{type:"i",value:2},colorPalette:{type:"t",value:a},texture:{type:"t",value:c},scale:{type:"f",value:1}};var d=new THREE.ShaderMaterial({uniforms:F,vertexShader:document.getElementById("vertexshader").textContent,fragmentShader:document.getElementById("fragmentshader").textContent,depthTest:!0,depthWrite:!0,transparent:!1,shading:THREE.FlatShading});K=new THREE.BufferGeometry;for(var e=new Float32Array(4*b.systems.length),f=new Float32Array(3*b.systems.length),g=new Float32Array(b.systems.length),h=0,j=0;h<b.systems.length;h++,j+=3){var l=b.systems[h];f[j+0]=l.x,f[j+1]=l.y,f[j+2]=l.z,e[4*h+0]=A.indexOf(b.systems[h].primary_economy),e[4*h+1]=C.indexOf(b.systems[h].allegiance),e[4*h+2]=B.indexOf(b.systems[h].government),e[4*h+3]=0,g[h]=i(l)}K.addAttribute("position",new THREE.BufferAttribute(f,3)),K.addAttribute("aColorIndex",new THREE.BufferAttribute(e,4)),K.addAttribute("aSize",new THREE.BufferAttribute(g,1)),K.attributes.aSize.needsUpdate=!0,I=new THREE.Points(K,d),I.sortParticles=!0,I.dynamic=!0,window.scene.add(I),M=!1,k()}function i(a){return a.population?50*Math.max(a.population/S,1):R}function j(a){var b=$(a.target);if(O.x=a.clientX/window.innerWidth*2-1,O.y=2*-(a.clientY/window.innerHeight)+1,!M&&T){var c=v(a);c?b.focus():(W.css({visibility:"hidden",display:"none"}),P.visible=!1)}}function k(){E=new THREE.TrackballControls(D,f[0]),E.rotateSpeed=10,E.zoomSpeed=2.2,E.panSpeed=2,E.noZoom=!1,E.noPan=!0,E.staticMoving=!0,E.dynamicDampingFactor=.3,E.keys=[65,83,68],E.minDistance=5,E.addEventListener("change",y),E.addEventListener("end",m)}function l(){T=!1}function m(){T=!0}function n(){Q=new THREE.CircleGeometry(.004,64),Q.vertices.shift(),P.add(new THREE.Line(Q,V)),P.visible=!1,P.name="targetCircle",window.scene.add(P)}function o(){var a=THREE.ImageUtils.loadTexture("images/icons/map/Marker-galaxy-map-green.png"),b=new THREE.SpriteMaterial({map:a,color:16777215,transparent:!0});L=new THREE.Sprite(b),L.name="selectedSystemIcon",L.visible=!1,L.scale.set(1,1.5,1),window.scene.add(L)}function p(){D=new THREE.PerspectiveCamera(90,window.innerWidth/window.innerHeight,1,999e3),D.position.set(0,0,50),D.lookAt(-25,0,0),window.scene=new THREE.Scene,q(!0),n(),o(),J=new THREE.Raycaster,J.params.PointCloud.threshold=.5,G=new THREE.WebGLRenderer,G.setSize(window.innerWidth,window.innerHeight),G.sortObjects=!0,f[0].appendChild(G.domElement),window.addEventListener("resize",r,!1),f[0].addEventListener("mousemove",j,!1),f[0].addEventListener("mousedown",function(a){U=new THREE.Vector2(a.pageX,a.pageY),l()}),f[0].addEventListener("mouseup",function(a){new THREE.Vector2(a.pageX,a.pageY).distanceToSquared(U)<1&&s(a),m()})}function q(a){if(a){F={speed:{type:"f",value:.2},color:{type:"v3",value:new THREE.Vector3(.2784313725490196,.34509803921568627,.8196078431372549)},brightness:{type:"f",value:.4},radius:{type:"f",value:.3},popSize:{type:"f",value:.05},baseSize:{type:"f",value:.9},uvScale:{type:"v2",value:new THREE.Vector2(1,1)},time:{type:"f",value:1}};var b=new THREE.ShaderMaterial({uniforms:F,vertexShader:document.getElementById("dotVertexShader").textContent,fragmentShader:document.getElementById("dotFragmentShader").textContent}),c=new THREE.PlaneGeometry(50,50,50);c.lookAt(D.position),H=new THREE.Mesh(c,b),H.position.set(-25,0,0),window.scene.add(H)}else window.scene.remove(H)}function r(a){G.setSize(window.innerWidth,window.innerHeight),D.aspect=window.innerWidth/window.innerHeight,D.updateProjectionMatrix()}function s(a){if(!M){var d=v(a);if(!d)return;var e=b.systems[d.index];c.$broadcast("selectedSystem:update",e)}}function t(a){l(),L.position.set(a),d.findStationsBySystemId(a.systemId);var b=function(){return D.position.z>0?5:-5};new TWEEN.Tween(D.position).to({x:a.x+5,y:a.y+5,z:a.z+b()}).easing(TWEEN.Easing.Linear.None).onComplete(function(){L.visible=!0,m()}).start(),new TWEEN.Tween(E.target).to({x:a.x,y:a.y,z:a.z}).easing(TWEEN.Easing.Linear.None).start()}function u(b){return a(function(a,c){P.visible=!0,P.lookAt(D.position);var d=i(b);return P.scale.set(d,d,d),a(P.position.set(b.x,b.y,b.z))}.bind(this))}function v(a){J.setFromCamera(O,D);var c=J.intersectObjects(window.scene.children);if(!Array.isArray(c)||!c[0])return!1;var d=c[0];if("selectedSystemIcon"!==d.object.name){var e=b.systems[d.index];return w(a,e.name),u(e),d}return c[1]?void(d=c[1]):!1}function w(b,c){return a(function(a,d){return W.css({top:b.offsetY-1-30,left:b.offsetX+1-40,visibility:"visible",display:"block"}),a(W.html(c))}.bind(this))}function x(a){M||(E.update(),L.position.copy(D.position),L.rotation.copy(D.rotation),L.updateMatrix(),L.translateZ(-30),L.translateY(.7)),requestAnimationFrame(x),TWEEN.update(a),y()}function y(){var a=N.getDelta();M&&(F.time.value+=5*a),G.autoClear=!1,G.clear(),G.render(window.scene,D)}var z=["economy","allegiance","government"],A=["None","Extraction","Refinery","Industrial","UNUSED","Agriculture","UNUSED","Terraforming","UNUSED","High Tech","Colony","Service","Tourism","Military"],B=["None","Confederacy","Prison Colony","Anarchy","Colony","Democracy","Imperial","Corporate","Communism","Feudal","Dictatorship","Theocracy","Cooperative","Patronage"],C=["None","Federation","UNUSED","Independent","UNUSED","UNUSED","Alliance","UNUSED","UNUSED","Empire","UNUSED","UNUSED","UNUSED","UNUSED"];window.scene;var D,E,F,G,H,I,J,K,L,M=!0,N=new THREE.Clock,O=new THREE.Vector2(0,0),P=new THREE.Object3D,Q=new THREE.CircleGeometry(50,64),R=100,S=1e9,T=!0,U=new THREE.Vector2,V=new THREE.LineBasicMaterial({color:"0xffffff"}),W=$("#pointer");b.init(),p(),x(),e.$on("selectedSystem:update",function(a,b){e.selectedSystem=b,L.visible=!1,t(e.selectedSystem)}),e.$on("systemColoring:update",function(a,b){var c=z.indexOf(b);0>c&&(console.error("Unknown system coloring type: "+b),c=0),F.activeColoring.value=c}),e.$watch(function(){return b.systems.length},function(a,c){b.systems.length>=1&&h()}),e.$watch(function(){return d.stations.length},function(a,b){d.stations.length>=1?e.stations=d.stations:e.stations=[]})}}}]),angular.module("edGalaxyMap").directive("footer",function(){return{restrict:"E",templateUrl:"scripts/directives/footer/footer.html",link:function(a,b,c){a.projectUrl="https://github.com/patrickrb/edGalaxyMap"}}}),angular.module("edGalaxyMap").directive("loadingSpinner",["$rootScope","$q","systemsService",function(a,b,c){return{restrict:"E",templateUrl:"scripts/directives/loadingSpinner/loadingSpinner.html",link:function(b,d,e){b.user={email:"burnsoft@gmail.com"},b.changeSystem=function(b,c,d,e){a.$broadcast("selectedSystem:update",b)},b.$watch(function(){return c.systems.length},function(a,d){c.systems.length>=1&&(b.systems=c.systems)})}}}]),angular.module("edGalaxyMap").controller("LoginModalCtrl",["$scope","$uibModalInstance","userService",function(a,b,c){a.user={email:null,password:null},a.login=function(a){c.login(a),b.close()},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("edGalaxyMap").directive("navbar",["$rootScope","$q","$uibModal","systemsService","userService","$cookieStore",function(a,b,c,d,e,f){return{restrict:"E",templateUrl:"scripts/directives/navbar/navbar.html",link:function(b,g,h){b.changeSystem=function(b,c,d,e){a.$broadcast("selectedSystem:update",b)},b.changeColoring=function(b){a.$broadcast("systemColoring:update",b)},b.$watch(function(){return d.systems.length},function(a,c){d.systems.length>=1&&(b.systems=d.systems)}),b.$watch(function(){return e.isLoggedIn},function(a,c){e.isLoggedIn?(b.user=f.get("user"),b.isLoggedIn=!0):b.isLoggedIn=!1}),b.logout=function(){e.logout()},b.openLoginModal=function(){var a=c.open({animation:b.animationsEnabled,templateUrl:"/scripts/directives/loginModal/loginModal.html",controller:"LoginModalCtrl",size:"md"});a.result.then(function(){},function(){})},b.openRegisterModal=function(){var a=c.open({animation:b.animationsEnabled,templateUrl:"/scripts/directives/registerModal/registerModal.html",controller:"RegisterModalCtrl",size:"md"});a.result.then(function(){},function(){})}}}}]),angular.module("edGalaxyMap").controller("RegisterModalCtrl",["$scope","$uibModalInstance","userService",function(a,b,c){a.registerUser={name:null,email:null,password:null},a.register=function(a){console.log("sending user: ",a),c.register(a),b.close()},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("edGalaxyMap").controller("StationModalCtrl",["$scope","$uibModalInstance","station","system","listingsService",function(a,b,c,d,e){e.findListingsByStationId(c.id),a.$watch(function(){return e.loading},function(b,c){e.loading?a.isLoading=!0:(a.isLoading=!1,a.listings=e.listings)}),a.system=d,a.station=c,a.ok=function(){b.close()},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("edGalaxyMap").directive("systemInfo",["$q","systemsService","stationsService","$uibModal",function(a,b,c,d){return{restrict:"E",templateUrl:"scripts/directives/systemInfo/systemInfo.html",link:function(a,b,e){a.$on("selectedSystem:update",function(b,c){a.selectedSystem=c}),a.$watch(function(){return c.loading},function(b,d){c.loading?(console.log("stations loading"),a.isLoading=!0):a.isLoading=!1}),a.open=function(b,c){var e=d.open({animation:a.animationsEnabled,templateUrl:"/scripts/directives/stationModal/stationModal.html",controller:"StationModalCtrl",size:"lg",resolve:{station:function(){return b},system:function(){return a.selectedSystem}}});e.result.then(function(){},function(){})}}}}]);