"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();angular.module("edGalaxyMap",["ui.bootstrap","ui.gravatar","ngRoute","ngCookies"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]).factory("authInterceptor",["$rootScope","$q","$cookieStore","$location",function(a,b,c,d){return{request:function(a){return a.headers=a.headers||{},c.get("token")&&(a.headers.Authorization="Bearer "+c.get("token")),a},responseError:function(a){return 401===a.status?(d.path("/login"),c.remove("token"),b.reject(a)):b.reject(a)}}}]),angular.module("edGalaxyMap").factory("listingsFactory",["$http",function(a){var b=function(){function b(){_classCallCheck(this,b)}return _createClass(b,[{key:"find",value:function(){return a.get("/api/listings").then(function(a){return a.data})}},{key:"findListingsByStationId",value:function(b){return a.get("/api/listings/station/"+b).then(function(a){return a.data})}}]),b}();return new b}]),angular.module("edGalaxyMap").factory("stationsFactory",["$http",function(a){var b=function(){function b(){_classCallCheck(this,b)}return _createClass(b,[{key:"find",value:function(){return a.get("/api/stations").then(function(a){return a.data})}},{key:"findStationsBySystemId",value:function(b){return a.get("/api/stations/"+b).then(function(a){return a.data})}}]),b}();return new b}]),angular.module("edGalaxyMap").factory("systemsFactory",["$http",function(a){var b=function(){function b(){_classCallCheck(this,b)}return _createClass(b,[{key:"find",value:function(){return a.get("/models/systems.json").then(function(a){return a.data})}}]),b}();return new b}]),angular.module("edGalaxyMap").factory("userFactory",["$http","$q","$cookieStore",function(a,b,c){var d=function(){function d(){_classCallCheck(this,d)}return _createClass(d,[{key:"login",value:function(d,e){var f=e||angular.noop,g=b.defer();return a.post("/auth/local",{email:d.email,password:d.password}).success(function(a){return c.put("token",a.token),c.put("user",a.user),g.resolve(a),f()}).error(function(a){return this.logout(),g.reject(a),f(a)}.bind(this)),g.promise}},{key:"register",value:function(d,e){var f=e||angular.noop,g=b.defer();return a.post("/api/user",{name:d.name,email:d.email,password:d.password}).success(function(a){return c.put("token",a.token),c.put("user",a.user),g.resolve(a),f()}).error(function(a){return this.logout(),g.reject(a),f(a)}.bind(this)),g.promise}},{key:"logout",value:function(){c.remove("token"),c.remove("user")}}]),d}();return new d}]),angular.module("edGalaxyMap").service("listingsService",["$q","listingsFactory",function(a,b){var c=function(){function c(){_classCallCheck(this,c),this.listings=[],this.loading=!1}return _createClass(c,[{key:"findListingsByStationId",value:function(c){return new a(function(a,d){this.loading=!0,this.listings.length=0,b.findListingsByStationId(c).then(function(a){this.listings=a,this.loading=!1,this.errors=!1}.bind(this)).then(a)["catch"](function(a){return this.loading=!1,this.errors=!0,d(a)}.bind(this))}.bind(this))}}]),c}();return new c}]),angular.module("edGalaxyMap").service("stationsService",["$q","stationsFactory",function(a,b){var c=function(){function c(){_classCallCheck(this,c),this.stations=[],this.selectedStation,this.loading=!1}return _createClass(c,[{key:"findStationsBySystemId",value:function(c){return new a(function(a,d){this.loading=!0,this.stations.length=0,b.findStationsBySystemId(c).then(function(a){this.stations=a,this.selectedStation=a[0],this.loading=!1,this.errors=!1}.bind(this)).then(a)["catch"](function(a){return this.loading=!1,this.errors=!0,d(a)}.bind(this))}.bind(this))}},{key:"findAllStations",value:function(){return new a(function(a,c){this.loading=!0,b.find().then(function(a){this.stations=a,this.selectedStation=a[0],this.loading=!1,this.errors=!1}.bind(this)).then(a)["catch"](function(a){return this.loading=!1,this.errors=!0,c(a)}.bind(this))}.bind(this))}}]),c}();return new c}]),angular.module("edGalaxyMap").service("systemsService",["$q","systemsFactory",function(a,b){var c=function(){function c(){_classCallCheck(this,c),this.systems=[],this.selectedSystem}return _createClass(c,[{key:"init",value:function(){return new a(function(a,c){this.loading=!0,b.find().then(function(a){this.systems=a,this.selectedSystem=a[0],this.loading=!1,this.errors=!1}.bind(this)).then(a)["catch"](function(a){return this.loading=!1,this.errors=!0,c(a)}.bind(this))}.bind(this))}},{key:"setSelectedSystem",value:function(a){this.selectedSystem=a}}]),c}();return new c}]),angular.module("edGalaxyMap").service("userService",["$q","userFactory","$cookieStore",function(a,b,c){var d=function(){function d(){_classCallCheck(this,d),this.isLoggedIn=!1}return _createClass(d,[{key:"init",value:function(){c.get("user")?(this.user=c.get("user"),this.isLoggedIn=!0):(this.user={},this.isLoggedIn=!1)}},{key:"login",value:function(c){return new a(function(a,d){this.loading=!0,b.login(c).then(function(a,b){this.user=a,this.isLoggedIn=!0,this.loading=!1,this.errors=!1}.bind(this)).then(a)["catch"](function(a){return this.user={},this.isLoggedIn=!1,this.loading=!1,this.errors=!0,d(a)}.bind(this))}.bind(this))}},{key:"register",value:function(c){return new a(function(a,d){this.loading=!0,b.register(c).then(function(a,b){this.user=a,this.isLoggedIn=!0,this.loading=!1,this.errors=!1}.bind(this)).then(a)["catch"](function(a){return this.user={},this.isLoggedIn=!1,this.loading=!1,this.errors=!0,d(a)}.bind(this))}.bind(this))}},{key:"logout",value:function(){this.user={},this.isLoggedIn=!1,b.logout()}}]),d}();return new d}]),angular.module("edGalaxyMap").controller("MainCtrl",["$scope","userService",function(a,b){b.init()}]),angular.module("edGalaxyMap").directive("edSystemMap",["$q","systemsService","$rootScope","stationsService",function(a,b,c,d){return{restrict:"E",link:function(e,f,g){function h(){o(!1);var a=THREE.ImageUtils.loadTexture("models/circle.png");a.minFilter=THREE.LinearFilter,z={color:{type:"c",value:new THREE.Color(16777215)},texture:{type:"t",value:a},scale:{type:"f",value:1},size:{type:"f",value:100}};var c=new THREE.ShaderMaterial({uniforms:z,vertexShader:document.getElementById("vertexshader").textContent,fragmentShader:document.getElementById("fragmentshader").textContent,depthTest:!0,depthWrite:!0,transparent:!1});E=new THREE.BufferGeometry;for(var d=new Float32Array(3*b.systems.length),e=new Float32Array(3*b.systems.length),f=new Float32Array(b.systems.length),g=new THREE.Color,h=16646144,j=16744192,l=16776960,m=8388352,n=39169,p=131071,q=3374847,r=83455,s=6685157,t=15073510,u=6710886,v=0,w=0;v<b.systems.length;v++,w+=3){var x=b.systems[v].primary_economy,y=b.systems[v];d[w+0]=y.x,d[w+1]=y.y,d[w+2]=y.z,"Extraction"==x?g.setHex(h):"Refinery"==x?g.setHex(j):"Industrial"==x?g.setHex(l):"Agriculture"==x?g.setHex(m):"Terraforming"==x?g.setHex(n):"High Tech"==x?g.setHex(p):"Colony"==x?g.setHex(q):"Service"==x?g.setHex(r):"Tourism"==x?g.setHex(s):"Military"==x?g.setHex(t):g.setHex(u),e[w+0]=g.r,e[w+1]=g.g,e[w+2]=g.b,f[v]=i(y)}E.addAttribute("position",new THREE.BufferAttribute(d,3)),E.addAttribute("customColor",new THREE.BufferAttribute(e,3)),E.addAttribute("aSize",new THREE.BufferAttribute(f,1)),E.attributes.aSize.needsUpdate=!0,C=new THREE.Points(E,c),C.sortParticles=!0,C.dynamic=!0,window.scene.add(C),G=!1,k()}function i(a){return a.population?25*Math.max(a.population/M,1):L}function j(a){var b=$(a.target);if(I.x=a.clientX/window.innerWidth*2-1,I.y=2*-(a.clientY/window.innerHeight)+1,!G){var c=t(a);c?b.focus():(O.css({visibility:"hidden",display:"none"}),J.visible=!1)}}function k(){y=new THREE.TrackballControls(x,f[0]),y.rotateSpeed=10,y.zoomSpeed=2.2,y.panSpeed=2,y.noZoom=!1,y.noPan=!0,y.staticMoving=!0,y.dynamicDampingFactor=.3,y.keys=[65,83,68],y.minDistance=5,y.addEventListener("change",w)}function l(){K=new THREE.CircleGeometry(.004,64),K.vertices.shift(),J.add(new THREE.Line(K,N)),J.visible=!1,J.name="targetCircle",window.scene.add(J)}function m(){var a=THREE.ImageUtils.loadTexture("images/icons/map/Marker-galaxy-map-green.png"),b=new THREE.SpriteMaterial({map:a,color:16777215,transparent:!0});F=new THREE.Sprite(b),F.name="selectedSystemIcon",F.visible=!1,F.scale.set(1,1.5,1),window.scene.add(F)}function n(){x=new THREE.PerspectiveCamera(90,window.innerWidth/window.innerHeight,1,999e3),x.position.set(0,0,50),x.lookAt(-25,0,0),window.scene=new THREE.Scene,o(!0),l(),m(),D=new THREE.Raycaster,D.params.PointCloud.threshold=.5,A=new THREE.WebGLRenderer,A.setSize(window.innerWidth,window.innerHeight),A.sortObjects=!0,f[0].appendChild(A.domElement),window.addEventListener("resize",p,!1),f[0].addEventListener("mousemove",j,!1),f[0].addEventListener("click",function(a){q(a)})}function o(a){if(a){z={speed:{type:"f",value:.2},color:{type:"v3",value:new THREE.Vector3(.2784313725490196,.34509803921568627,.8196078431372549)},brightness:{type:"f",value:.4},radius:{type:"f",value:.3},popSize:{type:"f",value:.05},baseSize:{type:"f",value:.9},uvScale:{type:"v2",value:new THREE.Vector2(1,1)},time:{type:"f",value:1}};var b=new THREE.ShaderMaterial({uniforms:z,vertexShader:document.getElementById("dotVertexShader").textContent,fragmentShader:document.getElementById("dotFragmentShader").textContent}),c=new THREE.PlaneGeometry(50,50,50);c.lookAt(x.position),B=new THREE.Mesh(c,b),B.position.set(-25,0,0),window.scene.add(B)}else window.scene.remove(B)}function p(a){A.setSize(window.innerWidth,window.innerHeight),x.aspect=window.innerWidth/window.innerHeight,x.updateProjectionMatrix()}function q(a){if(!G){var d=t(a);if(!d)return;var e=b.systems[d.index];c.$broadcast("selectedSystem:update",e)}}function r(a){F.position.set(a),d.findStationsBySystemId(a.systemId);var b=function(){return x.position.z>0?5:-5};new TWEEN.Tween(x.position).to({x:a.x+5,y:a.y+5,z:a.z+b()}).easing(TWEEN.Easing.Linear.None).onComplete(function(){F.visible=!0}).start(),new TWEEN.Tween(y.target).to({x:a.x,y:a.y,z:a.z}).easing(TWEEN.Easing.Linear.None).start()}function s(b){return a(function(a,c){J.visible=!0,J.lookAt(x.position);var d=i(b);return J.scale.set(d,d,d),a(J.position.set(b.x,b.y,b.z))}.bind(this))}function t(a){D.setFromCamera(I,x);var c=D.intersectObjects(window.scene.children);if(!Array.isArray(c)||!c[0])return!1;var d=c[0];if("selectedSystemIcon"!==d.object.name){var e=b.systems[d.index];return u(a,e.name),s(e),d}return c[1]?void(d=c[1]):!1}function u(b,c){return a(function(a,d){return O.css({top:b.offsetY-1-30,left:b.offsetX+1-40,visibility:"visible",display:"block"}),a(O.html(c))}.bind(this))}function v(a){G||(y.update(),F.position.copy(x.position),F.rotation.copy(x.rotation),F.updateMatrix(),F.translateZ(-30),F.translateY(.7)),requestAnimationFrame(v),TWEEN.update(a),w()}function w(){var a=H.getDelta();G&&(z.time.value+=5*a),A.autoClear=!1,A.clear(),A.render(window.scene,x)}window.scene;var x,y,z,A,B,C,D,E,F,G=!0,H=new THREE.Clock,I=new THREE.Vector2(0,0),J=new THREE.Object3D,K=new THREE.CircleGeometry(50,64),L=100,M=1e9,N=new THREE.LineBasicMaterial({color:"0xffffff"}),O=$("#pointer");b.init(),n(),v(),e.$on("selectedSystem:update",function(a,b){e.selectedSystem=b,F.visible=!1,r(e.selectedSystem)}),e.$watch(function(){return b.systems.length},function(a,c){b.systems.length>=1&&h()}),e.$watch(function(){return d.stations.length},function(a,b){d.stations.length>=1?e.stations=d.stations:e.stations=[]})}}}]),angular.module("edGalaxyMap").directive("footer",function(){return{restrict:"E",templateUrl:"scripts/directives/footer/footer.html",link:function(a,b,c){a.projectUrl="https://github.com/patrickrb/edGalaxyMap"}}}),angular.module("edGalaxyMap").directive("loadingSpinner",["$rootScope","$q","systemsService",function(a,b,c){return{restrict:"E",templateUrl:"scripts/directives/loadingSpinner/loadingSpinner.html",link:function(b,d,e){b.user={email:"burnsoft@gmail.com"},b.changeSystem=function(b,c,d,e){a.$broadcast("selectedSystem:update",b)},b.$watch(function(){return c.systems.length},function(a,d){c.systems.length>=1&&(b.systems=c.systems)})}}}]),angular.module("edGalaxyMap").controller("LoginModalCtrl",["$scope","$uibModalInstance","userService",function(a,b,c){a.user={email:null,password:null},a.login=function(a){c.login(a),b.close()},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("edGalaxyMap").directive("navbar",["$rootScope","$q","$uibModal","systemsService","userService","$cookieStore",function(a,b,c,d,e,f){return{restrict:"E",templateUrl:"scripts/directives/navbar/navbar.html",link:function(b,g,h){b.changeSystem=function(b,c,d,e){a.$broadcast("selectedSystem:update",b)},b.$watch(function(){return d.systems.length},function(a,c){d.systems.length>=1&&(b.systems=d.systems)}),b.$watch(function(){return e.isLoggedIn},function(a,c){e.isLoggedIn?(b.user=f.get("user"),b.isLoggedIn=!0):b.isLoggedIn=!1}),b.logout=function(){e.logout()},b.openLoginModal=function(){var a=c.open({animation:b.animationsEnabled,templateUrl:"/scripts/directives/loginModal/loginModal.html",controller:"LoginModalCtrl",size:"md"});a.result.then(function(){},function(){})},b.openRegisterModal=function(){var a=c.open({animation:b.animationsEnabled,templateUrl:"/scripts/directives/registerModal/registerModal.html",controller:"RegisterModalCtrl",size:"md"});a.result.then(function(){},function(){})}}}}]),angular.module("edGalaxyMap").controller("RegisterModalCtrl",["$scope","$uibModalInstance","userService",function(a,b,c){a.registerUser={name:null,email:null,password:null},a.register=function(a){console.log("sending user: ",a),c.register(a),b.close()},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("edGalaxyMap").controller("StationModalCtrl",["$scope","$uibModalInstance","station","system","listingsService",function(a,b,c,d,e){e.findListingsByStationId(c.id),a.$watch(function(){return e.loading},function(b,c){e.loading?a.isLoading=!0:(a.isLoading=!1,a.listings=e.listings)}),a.system=d,a.station=c,a.ok=function(){b.close()},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("edGalaxyMap").directive("systemInfo",["$q","systemsService","stationsService","$uibModal",function(a,b,c,d){return{restrict:"E",templateUrl:"scripts/directives/systemInfo/systemInfo.html",link:function(a,b,e){a.$on("selectedSystem:update",function(b,c){a.selectedSystem=c}),a.$watch(function(){return c.loading},function(b,d){c.loading?(console.log("stations loading"),a.isLoading=!0):a.isLoading=!1}),a.open=function(b,c){var e=d.open({animation:a.animationsEnabled,templateUrl:"/scripts/directives/stationModal/stationModal.html",controller:"StationModalCtrl",size:"lg",resolve:{station:function(){return b},system:function(){return a.selectedSystem}}});e.result.then(function(){},function(){})}}}}]);