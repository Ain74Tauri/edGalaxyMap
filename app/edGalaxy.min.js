"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();angular.module("edGalaxyMap",["ui.bootstrap","ui.gravatar","ngRoute","ngCookies","ngMaterial"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]).factory("authInterceptor",["$rootScope","$q","$cookieStore","$location",function(a,b,c,d){return{request:function(a){return a.headers=a.headers||{},c.get("token")&&(a.headers.Authorization="Bearer "+c.get("token")),a},responseError:function(a){return 401===a.status?(d.path("/login"),c.remove("token"),b.reject(a)):b.reject(a)}}}]),angular.module("edGalaxyMap").factory("colorsFactory",["$http",function(a){var b=function c(){_classCallCheck(this,c)};return new b}]),angular.module("edGalaxyMap").factory("listingsFactory",["$http",function(a){var b=function(){function b(){_classCallCheck(this,b)}return _createClass(b,[{key:"find",value:function(){return a.get("/api/listings").then(function(a){return a.data})}},{key:"findListingsByStationId",value:function(b){return a.get("/api/listings/station/"+b).then(function(a){return a.data})}}]),b}();return new b}]),angular.module("edGalaxyMap").factory("stationsFactory",["$http",function(a){var b=function(){function b(){_classCallCheck(this,b)}return _createClass(b,[{key:"find",value:function(){return a.get("/api/stations").then(function(a){return a.data})}},{key:"findStationsBySystemId",value:function(b){return a.get("/api/stations/"+b).then(function(a){return a.data})}}]),b}();return new b}]),angular.module("edGalaxyMap").factory("systemsFactory",["$http",function(a){var b=function(){function b(){_classCallCheck(this,b)}return _createClass(b,[{key:"find",value:function(){return a.get("/models/systems.json").then(function(a){return a.data})}}]),b}();return new b}]),angular.module("edGalaxyMap").factory("userFactory",["$http","$q","$cookieStore",function(a,b,c){var d=function(){function d(){_classCallCheck(this,d)}return _createClass(d,[{key:"login",value:function(d,e){var f=e||angular.noop,g=b.defer();return a.post("/auth/local",{email:d.email,password:d.password}).success(function(a){return c.put("token",a.token),c.put("user",a.user),g.resolve(a),f()}).error(function(a){return this.logout(),g.reject(a),f(a)}.bind(this)),g.promise}},{key:"register",value:function(d,e){var f=e||angular.noop,g=b.defer();return a.post("/api/user",{name:d.name,email:d.email,password:d.password}).success(function(a){return c.put("token",a.token),c.put("user",a.user),g.resolve(a),f()}).error(function(a){return this.logout(),g.reject(a),f(a)}.bind(this)),g.promise}},{key:"logout",value:function(){c.remove("token"),c.remove("user")}}]),d}();return new d}]),angular.module("edGalaxyMap").service("colorService",["$q","colorsFactory",function(a,b){var c=function(){function a(){_classCallCheck(this,a),this.colorPalette=["#666666","#fe0000","#ff7f00","#ffff00","#bfff00","#7fff00","#00ff15","#009901","#00ff80","#01ffff","#337eff","#0145ff","#6601e5","#e600e6"],this.map_colorTypes=["economy","allegiance","government"],this.map_economy=["None","Extraction","Refinery","Industrial","UNUSED","Agriculture","UNUSED","Terraforming","UNUSED","High Tech","Colony","Service","Tourism","Military"],this.map_government=["None","Confederacy","Prison Colony","Anarchy","Colony","Democracy","Imperial","Corporate","Communism","Feudal","Dictatorship","Theocracy","Cooperative","Patronage"],this.map_allegiance=["None","Federation","UNUSED","Independent","UNUSED","UNUSED","Alliance","UNUSED","UNUSED","Empire","UNUSED","UNUSED","UNUSED","UNUSED"],this.activeColors=[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],this.activeColorType="economy",this.paletteCanvas=document.createElement("canvas"),this.paletteCanvas.width=16,this.paletteCanvas.height=2,this.paletteContext=this.paletteCanvas.getContext("2d")}return _createClass(a,[{key:"setColoringType",value:function(a){this.activeColorType=a;for(var b=this.getColorNames(),c=0;c<this.activeColors.length;c++)this.activeColors[c]="UNUSED"!==b[c]}},{key:"setColorActive",value:function(a,b){void 0!==this.activeColors[a]&&(this.activeColors[a]=b)}},{key:"getColorNames",value:function(){return this["map_"+this.activeColorType]}},{key:"getActiveColors",value:function(){return this.activeColors}},{key:"isSystemActive",value:function(a){var b=this.activeColorType;"economy"==b&&(b="primary_economy");var c=a[b]||"None";return this.activeColors[this.getColorNames().indexOf(c)]}},{key:"getColorPaletteImage",value:function(){var a=this.getColorNames();this.paletteContext.clearRect(0,0,16,2);for(var b=0;b<this.activeColors.length;b++)"UNUSED"===a[b]?(this.paletteContext.fillStyle=this.colorPalette[0],this.paletteContext.fillRect(b,1,1,1)):this.activeColors[b]&&(this.paletteContext.fillStyle=this.colorPalette[b],this.paletteContext.fillRect(b,1,1,1));return this.paletteCanvas}}]),a}();return new c}]),angular.module("edGalaxyMap").service("listingsService",["$q","listingsFactory",function(a,b){var c=function(){function c(){_classCallCheck(this,c),this.listings=[],this.loading=!1}return _createClass(c,[{key:"findListingsByStationId",value:function(c){return new a(function(a,d){this.loading=!0,this.listings.length=0,b.findListingsByStationId(c).then(function(a){this.listings=a,this.loading=!1,this.errors=!1}.bind(this)).then(a)["catch"](function(a){return this.loading=!1,this.errors=!0,d(a)}.bind(this))}.bind(this))}}]),c}();return new c}]),angular.module("edGalaxyMap").service("stationsService",["$q","stationsFactory",function(a,b){var c=function(){function c(){_classCallCheck(this,c),this.stations=[],this.selectedStation,this.loading=!1}return _createClass(c,[{key:"findStationsBySystemId",value:function(c){return new a(function(a,d){this.loading=!0,this.stations.length=0,b.findStationsBySystemId(c).then(function(a){this.stations=a,this.selectedStation=a[0],this.loading=!1,this.errors=!1}.bind(this)).then(a)["catch"](function(a){return this.loading=!1,this.errors=!0,d(a)}.bind(this))}.bind(this))}},{key:"findAllStations",value:function(){return new a(function(a,c){this.loading=!0,b.find().then(function(a){this.stations=a,this.selectedStation=a[0],this.loading=!1,this.errors=!1}.bind(this)).then(a)["catch"](function(a){return this.loading=!1,this.errors=!0,c(a)}.bind(this))}.bind(this))}}]),c}();return new c}]),angular.module("edGalaxyMap").service("systemsService",["$q","systemsFactory",function(a,b){var c=function(){function c(){_classCallCheck(this,c),this.systems=[],this.selectedSystem}return _createClass(c,[{key:"init",value:function(){return new a(function(a,c){this.loading=!0,b.find().then(function(a){this.systems=a,this.selectedSystem=a[0],this.loading=!1,this.errors=!1}.bind(this)).then(a)["catch"](function(a){return this.loading=!1,this.errors=!0,c(a)}.bind(this))}.bind(this))}},{key:"setSelectedSystem",value:function(a){this.selectedSystem=a}}]),c}();return new c}]),angular.module("edGalaxyMap").service("userService",["$q","userFactory","$cookieStore",function(a,b,c){var d=function(){function d(){_classCallCheck(this,d),this.isLoggedIn=!1}return _createClass(d,[{key:"init",value:function(){c.get("user")?(this.user=c.get("user"),this.isLoggedIn=!0):(this.user={},this.isLoggedIn=!1)}},{key:"login",value:function(c){return new a(function(a,d){this.loading=!0,b.login(c).then(function(a,b){this.user=a,this.isLoggedIn=!0,this.loading=!1,this.errors=!1}.bind(this)).then(a)["catch"](function(a){return this.user={},this.isLoggedIn=!1,this.loading=!1,this.errors=!0,d(a)}.bind(this))}.bind(this))}},{key:"register",value:function(c){return new a(function(a,d){this.loading=!0,b.register(c).then(function(a,b){this.user=a,this.isLoggedIn=!0,this.loading=!1,this.errors=!1}.bind(this)).then(a)["catch"](function(a){return this.user={},this.isLoggedIn=!1,this.loading=!1,this.errors=!0,d(a)}.bind(this))}.bind(this))}},{key:"logout",value:function(){this.user={},this.isLoggedIn=!1,b.logout()}}]),d}();return new d}]),angular.module("edGalaxyMap").controller("MainCtrl",["$scope","userService",function(a,b){b.init()}]),angular.module("edGalaxyMap").directive("colorSelection",["$rootScope","$q","colorService","$uibModal",function(a,b,c,d){return{restrict:"E",templateUrl:"scripts/directives/colorSelection/colorSelection.html",link:function(b,d,e){b.$on("selectedSystem:update",function(a,c){b.selectedSystem=c}),b.$on("systemColoring:update",function(a,d){b.colorNames=c.getColorNames(),b.activeColors=c.getActiveColors()}),b.updateColorFlags=function(d){c.setColorActive(d,b.activeColors[d]),a.$broadcast("systemColoring:updateActives")},b.colorNames=c.getColorNames(),b.activeColors=c.getActiveColors(),b.colors=c.colorPalette}}}]),angular.module("edGalaxyMap").directive("edSystemMap",["$q","systemsService","$rootScope","stationsService","colorService",function(a,b,c,d,e){return{restrict:"E",link:function(f,g,h){function i(){var a=e.getColorPaletteImage();K=new THREE.Texture(a),K.needsUpdate=!0,K.minFilter=THREE.NearestFilter,K.magFilter=THREE.NearestFilter,D.colorPalette.value=K}function j(){s(!1);var a=THREE.ImageUtils.loadTexture("models/circle.png");a.minFilter=THREE.LinearFilter,D={activeColoring:{type:"i",value:0},colorPalette:{type:"t",value:null},texture:{type:"t",value:a},scale:{type:"f",value:1}},i();var c=new THREE.ShaderMaterial({uniforms:D,vertexShader:document.getElementById("vertexshader").textContent,fragmentShader:document.getElementById("fragmentshader").textContent,depthTest:!0,depthWrite:!0,transparent:!1,shading:THREE.FlatShading});I=new THREE.BufferGeometry;for(var d=new Float32Array(4*b.systems.length),f=new Float32Array(3*b.systems.length),g=new Float32Array(b.systems.length),h=0,j=0;h<b.systems.length;h++,j+=3){var l=b.systems[h];f[j+0]=l.x,f[j+1]=l.y,f[j+2]=l.z,d[4*h+0]=e.map_economy.indexOf(b.systems[h].primary_economy),d[4*h+1]=e.map_allegiance.indexOf(b.systems[h].allegiance),d[4*h+2]=e.map_government.indexOf(b.systems[h].government),d[4*h+3]=0,g[h]=k(l)}I.addAttribute("position",new THREE.BufferAttribute(f,3)),I.addAttribute("aColorIndex",new THREE.BufferAttribute(d,4)),I.addAttribute("aSize",new THREE.BufferAttribute(g,1)),I.attributes.aSize.needsUpdate=!0,I.attributes.aColorIndex.needsUpdate=!0,G=new THREE.Points(I,c),G.sortParticles=!0,G.dynamic=!0,window.scene.add(G),L=!1,m()}function k(a){return a.population?50*Math.max(a.population/R,1):Q}function l(a){var b=$(a.target);if(N.x=a.clientX/window.innerWidth*2-1,N.y=2*-(a.clientY/window.innerHeight)+1,!L&&S){var c=x(a);c?b.focus():(V.css({visibility:"hidden",display:"none"}),O.visible=!1)}}function m(){C=new THREE.TrackballControls(B,g[0]),C.rotateSpeed=10,C.zoomSpeed=2.2,C.panSpeed=2,C.noZoom=!1,C.noPan=!0,C.staticMoving=!0,C.dynamicDampingFactor=.3,C.keys=[65,83,68],C.minDistance=5,C.addEventListener("change",A),C.addEventListener("end",o)}function n(){S=!1}function o(){S=!0}function p(){P=new THREE.CircleGeometry(.004,64),P.vertices.shift(),O.add(new THREE.Line(P,U)),O.visible=!1,O.name="targetCircle",window.scene.add(O)}function q(){var a=THREE.ImageUtils.loadTexture("images/icons/map/Marker-galaxy-map-green.png"),b=new THREE.SpriteMaterial({map:a,color:16777215,transparent:!0});J=new THREE.Sprite(b),J.name="selectedSystemIcon",J.visible=!1,J.scale.set(1,1.5,1),window.scene.add(J)}function r(){B=new THREE.PerspectiveCamera(90,window.innerWidth/window.innerHeight,1,999e3),B.position.set(0,0,50),B.lookAt(-25,0,0),window.scene=new THREE.Scene,s(!0),p(),q(),H=new THREE.Raycaster,H.params.PointCloud.threshold=.5,E=new THREE.WebGLRenderer,E.setSize(window.innerWidth,window.innerHeight),E.sortObjects=!0,g[0].appendChild(E.domElement),window.addEventListener("resize",t,!1),g[0].addEventListener("mousemove",l,!1),g[0].addEventListener("mousedown",function(a){T=new THREE.Vector2(a.pageX,a.pageY),n()}),g[0].addEventListener("mouseup",function(a){new THREE.Vector2(a.pageX,a.pageY).distanceToSquared(T)<1&&u(a),o()})}function s(a){if(a){D={speed:{type:"f",value:.2},color:{type:"v3",value:new THREE.Vector3(.2784313725490196,.34509803921568627,.8196078431372549)},brightness:{type:"f",value:.4},radius:{type:"f",value:.3},popSize:{type:"f",value:.05},baseSize:{type:"f",value:.9},uvScale:{type:"v2",value:new THREE.Vector2(1,1)},time:{type:"f",value:1}};var b=new THREE.ShaderMaterial({uniforms:D,vertexShader:document.getElementById("dotVertexShader").textContent,fragmentShader:document.getElementById("dotFragmentShader").textContent}),c=new THREE.PlaneGeometry(50,50,50);c.lookAt(B.position),F=new THREE.Mesh(c,b),F.position.set(-25,0,0),window.scene.add(F)}else window.scene.remove(F)}function t(a){E.setSize(window.innerWidth,window.innerHeight),B.aspect=window.innerWidth/window.innerHeight,B.updateProjectionMatrix()}function u(a){if(!L){var d=x(a);if(!d)return;var e=b.systems[d.index];c.$broadcast("selectedSystem:update",e)}}function v(a){n(),J.position.set(a),d.findStationsBySystemId(a.systemId);var b=function(){return B.position.z>0?5:-5};new TWEEN.Tween(B.position).to({x:a.x+5,y:a.y+5,z:a.z+b()}).easing(TWEEN.Easing.Linear.None).onComplete(function(){J.visible=!0,o()}).start(),new TWEEN.Tween(C.target).to({x:a.x,y:a.y,z:a.z}).easing(TWEEN.Easing.Linear.None).start()}function w(b){return a(function(a,c){O.visible=!0,O.lookAt(B.position);var d=k(b);return O.scale.set(d,d,d),a(O.position.set(b.x,b.y,b.z))}.bind(this))}function x(a){H.setFromCamera(N,B);var c=H.intersectObjects(window.scene.children);if(!Array.isArray(c)||!c[0])return!1;var d=c[0];if("selectedSystemIcon"!==d.object.name){var f=b.systems[d.index];return e.isSystemActive(f)?(y(a,f.name),w(f),d):!1}return c[1]?void(d=c[1]):!1}function y(b,c){return a(function(a,d){return V.css({top:b.offsetY-1-30,left:b.offsetX+1-40,visibility:"visible",display:"block"}),a(V.html(c))}.bind(this))}function z(a){L||(C.update(),J.position.copy(B.position),J.rotation.copy(B.rotation),J.updateMatrix(),J.translateZ(-30),J.translateY(.7)),requestAnimationFrame(z),TWEEN.update(a),A()}function A(){var a=M.getDelta();L&&(D.time.value+=5*a),E.autoClear=!1,E.clear(),E.render(window.scene,B)}window.scene;var B,C,D,E,F,G,H,I,J,K,L=!0,M=new THREE.Clock,N=new THREE.Vector2(0,0),O=new THREE.Object3D,P=new THREE.CircleGeometry(50,64),Q=100,R=1e9,S=!0,T=new THREE.Vector2,U=new THREE.LineBasicMaterial({color:"0xffffff"}),V=$("#pointer");b.init(),r(),z(),f.$on("selectedSystem:update",function(a,b){f.selectedSystem=b,J.visible=!1,v(f.selectedSystem)}),f.$on("systemColoring:update",function(a,b){var c=e.map_colorTypes.indexOf(b);0>c&&(console.error("Unknown system coloring type: "+b),c=0),D.activeColoring.value=c,i()}),f.$on("systemColoring:updateActives",i),f.$watch(function(){return b.systems.length},function(a,c){b.systems.length>=1&&j()}),f.$watch(function(){return d.stations.length},function(a,b){d.stations.length>=1?f.stations=d.stations:f.stations=[]})}}}]),angular.module("edGalaxyMap").directive("footer",function(){return{restrict:"E",templateUrl:"scripts/directives/footer/footer.html",link:function(a,b,c){a.projectUrl="https://github.com/patrickrb/edGalaxyMap"}}}),angular.module("edGalaxyMap").directive("loadingSpinner",["$rootScope","$q","systemsService",function(a,b,c){return{restrict:"E",templateUrl:"scripts/directives/loadingSpinner/loadingSpinner.html",link:function(b,d,e){b.user={email:"burnsoft@gmail.com"},b.changeSystem=function(b,c,d,e){a.$broadcast("selectedSystem:update",b)},b.$watch(function(){return c.systems.length},function(a,d){c.systems.length>=1&&(b.systems=c.systems)})}}}]),angular.module("edGalaxyMap").controller("LoginModalCtrl",["$scope","$uibModalInstance","userService",function(a,b,c){a.user={email:null,password:null},a.login=function(a){c.login(a),b.close()},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("edGalaxyMap").directive("navbar",["$rootScope","$q","$uibModal","systemsService","userService","colorService","$cookieStore",function(a,b,c,d,e,f,g){return{restrict:"E",templateUrl:"scripts/directives/navbar/navbar.html",link:function(b,h,i){b.changeSystem=function(b,c,d,e){a.$broadcast("selectedSystem:update",b)},b.changeColoring=function(b){f.setColoringType(b),a.$broadcast("systemColoring:update",b)},b.$watch(function(){return d.systems.length},function(a,c){d.systems.length>=1&&(b.systems=d.systems)}),b.$watch(function(){return e.isLoggedIn},function(a,c){e.isLoggedIn?(b.user=g.get("user"),b.isLoggedIn=!0):b.isLoggedIn=!1}),b.logout=function(){e.logout()},b.openLoginModal=function(){var a=c.open({animation:b.animationsEnabled,templateUrl:"/scripts/directives/loginModal/loginModal.html",controller:"LoginModalCtrl",size:"md"});a.result.then(function(){},function(){})},b.openRegisterModal=function(){var a=c.open({animation:b.animationsEnabled,templateUrl:"/scripts/directives/registerModal/registerModal.html",controller:"RegisterModalCtrl",size:"md"});a.result.then(function(){},function(){})}}}}]),angular.module("edGalaxyMap").controller("RegisterModalCtrl",["$scope","$uibModalInstance","userService",function(a,b,c){a.registerUser={name:null,email:null,password:null},a.register=function(a){console.log("sending user: ",a),c.register(a),b.close()},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("edGalaxyMap").controller("StationModalCtrl",["$scope","$uibModalInstance","station","system","listingsService",function(a,b,c,d,e){e.findListingsByStationId(c.id),a.$watch(function(){return e.loading},function(b,c){e.loading?a.isLoading=!0:(a.isLoading=!1,a.listings=e.listings)}),a.system=d,a.station=c,a.ok=function(){b.close()},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("edGalaxyMap").directive("systemInfo",["$q","systemsService","stationsService","$uibModal",function(a,b,c,d){return{restrict:"E",templateUrl:"scripts/directives/systemInfo/systemInfo.html",link:function(a,b,e){a.$on("selectedSystem:update",function(b,c){a.selectedSystem=c}),a.$watch(function(){return c.loading},function(b,d){c.loading?(console.log("stations loading"),a.isLoading=!0):a.isLoading=!1}),a.open=function(b,c){var e=d.open({animation:a.animationsEnabled,templateUrl:"/scripts/directives/stationModal/stationModal.html",controller:"StationModalCtrl",size:"lg",resolve:{station:function(){return b},system:function(){return a.selectedSystem}}});e.result.then(function(){},function(){})}}}}]);
